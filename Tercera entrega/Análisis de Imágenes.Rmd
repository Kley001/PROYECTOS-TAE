---
title: "Análisis de imágenes"
author: "Alexis"
date: "28/01/2022"
output: html_document
---

# Análisis de imágenes con o sin gafas


Para este ejemplo, usaremos datos del proyecto Kaggle (https://www.kaggle.com/jeffheaton/glasses-or-no-glasses).

En este proyecto se usó inteligencia artifical para generar rostros de 5000 personas, a partir de esa información, se filtaron los datos como "con gafas" o "sin gafas" y fueron descargados a partir del siguiente link:

https://drive.google.com/drive/folders/12m0U3V5tYAfDuGDsa8ikLRNRzTurpkJF?usp=sharing

Datos descargados el 28 de enero de 2022 a las 12:42pm (EMT-3).

## Paso 0. Describir una forma de comparar los vectores.

Para esto usaremos una muestra de 6 personas (3 con gafas y 3 sin gafas). Las figuras serán analizadas con el paquete EBImage. Para más información, pueden entrar al [site de Bioconductor](https://bioconductor.org/packages/release/bioc/html/EBImage.html)

```{r}

#Entrar al directorio base

setwd("/Users/alexis.carrasco/Documents/1. Jesus Santos/Modelos/")

#Abrir el paquete EBImage
library("EBImage")

#Abrir las imágenes del modelo
list.files()->lista

#Ver las figuras citadas
lista

#Luego, abriremos una de esas figuras
imagename <-lista[1]
img = readImage(imagename)
imagename <-lista[2]
img2 = readImage(imagename)
#Podemos mostrarla con el siguiente código
display(img,method='raster',all=TRUE)
display(img2,method='raster',all=TRUE)
#Para facilitar la visualización y vectorización, podemos convertirla a escala de grises.
img_g<-channel(img,"gray")
img_g2<-channel(img2,"gray")
display(img_g,method='raster',all=TRUE)
display(img_g2,method='raster',all=TRUE)
#Ya que todas las figuras fueron creadas por computadora, los lentes se ubicarán casi en la misma posición, entonces podemos delimitarlas con esta función

img_crop = img_g[150:900,360:650]
display(img_crop,method='raster',all=TRUE)

img_crop2 = img_g2[150:900,360:650]
display(img_crop2,method='raster',all=TRUE)

#Inclusive, podríamos cortar sólo el septo central

img_crop = img_g[440:590,440:580]
display(img_crop,method='raster',all=TRUE)

img_crop2 = img_g2[440:590,440:580]
display(img_crop2,method='raster',all=TRUE)

#Finalmente, vimos que habían diferencias entre los histogramas de personas con o sin gafas.


for (i in 1:6){
imagename <-lista[i]

img = readImage(imagename)

img_g<-channel(img,"gray")

img_crop = img_g[440:590,440:580]
par(mfrow=c(1,2))
display(img_crop*2,method='raster',all=TRUE)

hist(img_crop,breaks=100)
}

```

## Paso 1. Vamos a crear una matriz con datos de intensidad para los Describir una forma de comparar los vectores.

```{r, eval=FALSE}

#Entrar al directorio base

setwd("/Users/alexis.carrasco/Documents/1. Jesus Santos/Con gafas_training/")

#Abrir el paquete EBImage
library("EBImage")

#Abrir las imágenes del modelo
list.files()->lista

#Vamos a crear una columna con los cuartiles necesarios (basado en el concepto de histograma)

paste0(seq(0,0.995,0.005),"-",seq(0.005,1,0.005))->cuartiles

data.frame(values=cuartiles)->gafas

for (i in 1:length(lista)){
imagename <-lista[i]

img = readImage(imagename)

img_g<-channel(img,"gray")

img_crop = img_g[440:590,440:580]
hist(img_crop,breaks=seq(0,1,0.005))->dados
data.frame(gafas,dados$counts)->gafas

}
colnames(gafas)<-c("values",lista)

#Salvando este resultado

write.csv(gafas,"/Users/alexis.carrasco/Documents/1. Jesus Santos/FotosConGafas.csv")
```


## Paso2. Repetir el paso 1 para el grupo de fotos sin gafas.

```{r setup, eval=FALSE, message=FALSE}

#Entrar al directorio base

setwd("/Users/alexis.carrasco/Documents/1. Jesus Santos/Sin gafas_training/")

#Abrir el paquete EBImage
library("EBImage")

#Abrir las imágenes del modelo
list.files()->lista

#Vamos a crear una columna con los cuartiles necesarios (basado en el concepto de histograma)

paste0(seq(0,0.995,0.005),"-",seq(0.005,1,0.005))->cuartiles

data.frame(values=cuartiles)->Sgafas

for (i in 1:length(lista)){
imagename <-lista[i]

img = readImage(imagename)

img_g<-channel(img,"gray")

img_crop = img_g[440:590,440:580]
hist(img_crop,breaks=seq(0,1,0.005))->dados
data.frame(Sgafas,dados$counts)->Sgafas

}
colnames(Sgafas)<-c("values",lista)

#Salvando este resultado

write.csv(Sgafas,"/Users/alexis.carrasco/Documents/1. Jesus Santos/FotosSinGafas.csv")
```

Hasta aquí, tenemos archivos guardados para facilitar los próximos pasos...

## Paso 3. Formatear los datos y realizar el análisis de componentes.

En este modelo, generamos 200 valores numéricos para cada imagen recortada. Estos valores representan el número de píxeles con intensidades desde 0 (más oscuro) hasta 1 (más claro).

En este caso, usaremos los paquetes [tidyverse](https://www.tidyverse.org/packages/) y [ggplot2](https://ggplot2.tidyverse.org/).
```{r, fig.dim = c(18, 6), dpi=600, message=FALSE}

#Entrar al directorio base

setwd("/Users/alexis.carrasco/Documents/1. Jesus Santos/")

#Leer los archivos

read.csv("FotosConGafas.csv")->gafas

read.csv("FotosSinGafas.csv")->Sgafas

#Vamos a ver rápidamente los archivos:

gafas[1:5,1:5]

Sgafas[1:5,1:5]


#Vamos a formatearlos

gafas[,2]->rownames(gafas)
gafas[,-c(1:2)]->gafas
t(gafas)->gafas


Sgafas[,2]->rownames(Sgafas)
Sgafas[,-c(1:2)]->Sgafas
t(Sgafas)->Sgafas

#Juntando la información

train<-data.frame(rbind(gafas,Sgafas),grupo=c(rep("Con_Gafas",nrow(gafas)),rep("Sin_Gafas",nrow(Sgafas))))
colnames(train)<-c(colnames(gafas),"grupo")

write.csv(train,"train_1.csv")
#Chequeando los histogramas

library(tidyverse)
train%>%pivot_longer(!grupo,names_to="range",values_to="value")->datos
library(ggplot2)

ggplot(datos, aes(x=range, y=value, color=grupo)) +
  geom_boxplot()+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1,size=8))

png("Boxplot_general.png",width=12000, height=5000,res=600)
ggplot(datos, aes(x=range, y=value, color=grupo)) +
  geom_boxplot()+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1,size=8))
dev.off()

```

Con estos datos, vemos que notablemente, hay un mayor número de pixeles de baja intensidad (más oscuros) en el grupo de fotos con gafas. Entonces, iniciaremos la predicción de datos con un cálculo PCA.

## Paso4. Análisis de componentes principales

Este análisis es realizado para reducir el número de variables y establecer un modelo predictivo.

Aquí usamos el paquete [pls](https://cran.r-project.org/web/packages/pls/vignettes/pls-manual.pdf) 

```{r}

#Ejecutando el PCA

library(pls)
library(tidyverse)
library(dplyr)

mutate(train,grupo=ifelse(grupo=="Con_Gafas",1,0))->train2

#creación del modelo
pcr(grupo~.,data=train2[,c(1:60,201)],scale=TRUE,validation="CV")->model

#Prueba redundante 
predict(model,train2[,-201],ncomp=10)->prob

#Si se desea, se pueden juntar los datos creados con los valores reales (columna grupo de la tabla train)
 cbind(prob,train2[,201])->prob

 write.csv(prob,"datos_generados.csv")
 
```

Con esto tendríamos el modelo creado. Sin embargo, hay algunos detalles que escapan al cálculo. En este análisis, percibimos casos donde la predicción era muy baja en fotos con gafas (debido a lentes finos) o muy alta en fotos sin gafas (debido a piel oscura).

Se muestran algunos ejemplos:

```{r, echo=FALSE}
setwd("/Users/alexis.carrasco/Documents/1. Jesus Santos/Sin gafas_training/")

#Abrir el paquete EBImage
library("EBImage")

#Abrir las imágenes del modelo
list.files()->lista

i<-127
imagename <-lista[i]

img = readImage(imagename)

img_g<-channel(img,"gray")

img_crop = img_g[440:590,440:580]
display(img_g,method='raster')

setwd("/Users/alexis.carrasco/Documents/1. Jesus Santos/Con gafas_training/")

#Abrir el paquete EBImage
library("EBImage")

#Abrir las imágenes del modelo
list.files()->lista

i<-219
imagename <-lista[i]

img = readImage(imagename)

img_g<-channel(img,"gray")

img_crop = img_g[440:590,440:580]
display(img_g,method='raster')

```

A pesar de esto, tenemos buenos resultados en relación al porcentaje estimado y el valor real (con o sin gafas)

```{r}
setwd("/Users/alexis.carrasco/Documents/1. Jesus Santos/")
read.csv("datos_generados.csv")->datos

#En el siguiente gráfico, se muestra como 0, aquellas imágenes que no deberían tener gafas y como 1, aquellas que deberían mostrar gafas. 
ggplot(datos,aes(x=as.factor(X.1),y=prob))+geom_violin()

#Para comprobar los datos y las diferencias significativas, podemos ejecutar un análisis de comparación de promedios (prueba t)
t.test(datos[which(datos$X.1==1),2],datos[which(datos$X.1==0),2])

```

## Paso5. Leyendo fotos de evaluación

Los sistemas predictivos basados en imágenes, incluyen una lógica avanzada. Sin embargo, requieren de términos específicos. En este caso, el entrenamiento se realizó con fotos de frente (straight), entonces la validación debe hacerse con el mismo tipo de fotos.

Tenemos 424 fotos con esta característica, vamos a analizarlas con el paquete [pixmap] (https://www.rdocumentation.org/packages/pixmap/versions/0.4-12/topics/pnm)

```{r, eval=FALSE}
library(pixmap)

setwd("/Users/alexis.carrasco/Documents/1. Jesus Santos/TestValido/")

list.files()->lista

#Convertir todo para png
for (i in 1:length(lista)){
read.pnm(lista[i])->a
png(paste0(lista[i],".png"))
plot(a)
dev.off()
}

```

## Paso 6. Calibrar la región de lectura

Ahora que ya tenemos todo en formato png, repetiremos los pasos iniciales para calcular los histogramas del grupo de evaluación.

```{r, eval=FALSE}
setwd("/Users/alexis.carrasco/Documents/1. Jesus Santos/Test_PNG/")

#Abrir el paquete EBImage
library("EBImage")

#Abrir las imágenes del modelo
list.files()->lista

#Vamos a crear una columna con los cuartiles necesarios (basado en el concepto de histograma)

paste0(seq(0,0.995,0.005),"-",seq(0.005,1,0.005))->cuartiles

data.frame(values=cuartiles)->test

for (i in 1:length(lista)){
imagename <-lista[i]

img = readImage(imagename)

img_g<-channel(img,"gray")

img_crop = img_g[245:265,200:250]
hist(img_crop,breaks=seq(0,1,0.005))->dados
data.frame(test,dados$counts)->test

}
colnames(test)<-c("values",lista)

#Guardando este resultado

write.csv(test,"/Users/alexis.carrasco/Documents/1. Jesus Santos/test.csv")

```

## Paso 7. Probando el modelo creado 


```{r}

setwd("/Users/alexis.carrasco/Documents/1. Jesus Santos/")

read.csv("train_1.csv")->train

library(dplyr)

train[,1]->rownames(train)
train[,-1]->train

mutate(train,grupo=ifelse(grupo=="Con_Gafas",1,0))->train2

library(pls)

#creación del modelo
pcr(grupo~.,data=train2[,c(1:60,201)],scale=TRUE,validation="CV")->model

#Prueba con grupo test
read.csv("test.csv")->test
test[,2]->rownames(test) 
test[,-c(1:2)]->test
t(test)->test

predict(model,newdata=test[,1:60],ncomp=10)->prob

#Si se desea, se pueden juntar los datos creados con los valores reales (columna grupo de la tabla train)
  write.csv(prob,"resultados.csv")
 
```


## Paso 9. Revisión de los resultados

```{r}
setwd("/Users/alexis.carrasco/Documents/1. Jesus Santos/")
read.csv("resultados.csv")->datos

library(data.table)
rbind(mutate(datos[datos$X %like% "open",],grupo="Sin_gafas"),
      mutate(datos[datos$X %like% "sungla",],grupo="Con_gafas"))->datos2


ggplot(datos2,aes(x=grupo,y=grupo.10.comps))+geom_boxplot()+scale_y_log10()
#Para comprobar los datos y las diferencias significativas, podemos ejecutar un análisis de comparación de promedios (prueba t)
t.test(datos2[which(datos2$grupo=="Con_gafas"),2],datos[which(datos2$grupo=="Sin_gafas"),2])

```
